@using LiveChartsCore.Kernel
@using LiveChartsCore.Themes
@using MaterialColorUtilities.Palettes
@using MaterialColorUtilities.Schemes
@using MaterialColorUtilities.Utils
@using Environment = Environment

@inherits LayoutComponentBase

<CustomThemeProvider @ref="themeProvider" Theme="theme" @bind-IsDarkMode="@ThemeService.IsDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
	<MudAppBar Elevation="1">
		<MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" Class="mr-4" OnClick="() => drawerOpen = !drawerOpen" />
		<MudImage Style="height: calc(100% - 16px)" Src="data:image/webp;base64,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"></MudImage>
		<div class="mud-typography-h5 ml-2">Rocket Explorer @(Configuration.Environment != Environment.Mainnet ? $"({Configuration.Environment})" : "")</div>
		<MudSpacer />
		<MudTooltip Text="@(DarkLightModeButtonText)">
			<MudIconButton Icon="@(DarkLightModeButtonIcon)" Color="Color.Inherit" OnClick="() => ThemeService.CycleDarkLightMode()" aria-label="@(DarkLightModeButtonText)" />
		</MudTooltip>
		<MudTooltip Text="Open GitHub">
			<MudIconButton Href="https://github.com/Dresel/rocketexplorer" Target="_blank" Icon="@Icons.Custom.Brands.GitHub" Color="Color.Inherit" aria-label="Open GitHub" />
		</MudTooltip>
	</MudAppBar>
	<MudDrawer @bind-Open="@drawerOpen">
		<NavMenu />
	</MudDrawer>
	<MudMainContent>
		<CascadingValue Value="@themeProvider">
			<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8 mb-8">@Body</MudContainer>
		</CascadingValue>
	</MudMainContent>
	@if (AppState.CurrentBlock != null)
	{
		<div Class="footer">
			<MudContainer MaxWidth="MaxWidth.Large">
				<MudText Typo="Typo.body2" Style="color: var(--mud-palette-text-secondary)" Align="Align.Right">Last processed block: @AppState.ProcessedBlockNumber (@(AppState.BlockDifference == 0 ? "up to date" : $"{AppState.BlockDifference} blocks ago"))</MudText>
			</MudContainer>
		</div>
	}
</MudLayout>

@code {

	private string ObjectStoreMetadataUrl => $"{Configuration.ObjectStoreBaseUrl}/snapshot-metadata.msgpack";

	private string DarkLightModeButtonText => ThemeService.CurrentDarkLightMode switch
	{
		DarkLightMode.Dark => "Use system mode",
		DarkLightMode.Light => "Use dark mode",
		_ => "Use light mode",
	};

	private string DarkLightModeButtonIcon => ThemeService.CurrentDarkLightMode switch
	{
		DarkLightMode.Dark => Icons.Material.Rounded.AutoMode,
		DarkLightMode.Light => Icons.Material.Outlined.DarkMode,
		_ => Icons.Material.Filled.LightMode,
	};

	private void SetMudTheme()
	{
		uint brandColor = ColorUtils.ArgbFromRgb(255, 110, 48);
		uint markColor = ColorUtils.ArgbFromRgb(255, 235, 59);

		Scheme<uint> darkSchemeVibrant = new DarkSchemeMapper().Map(CorePalette.Of(brandColor, Style.Vibrant));
		CorePalette markPalette = CorePalette.Of(markColor, Style.Vibrant);

		PaletteLight paletteLight = SetPalette(new CustomPaletteLight(), new LightSchemeMapper().Map(CorePalette.Of(brandColor, Style.Vibrant)), new LightSchemeMapper().Map(markPalette));

		// Override primary colors with vibrant style
		PaletteDark paletteDark = SetPalette(new CustomPaletteDark(), new DarkSchemeMapper().Map(CorePalette.Of(brandColor, Style.Spritz)), new DarkSchemeMapper().Map(markPalette));
		paletteDark.Primary = darkSchemeVibrant.Primary.ToMudColor();
		paletteDark.PrimaryContrastText = darkSchemeVibrant.OnPrimary.ToMudColor();
		paletteDark.AppbarText = darkSchemeVibrant.OnPrimary.ToMudColor();
		paletteDark.AppbarBackground = darkSchemeVibrant.Primary.ToMudColor();

		theme = new MudTheme
		{
			Typography = CreateTypography(),
			PaletteLight = paletteLight,
			PaletteDark = paletteDark,
		};
	}

	private T SetPalette<T>(T palette, Scheme<uint> scheme, Scheme<uint> markScheme) where T : Palette
	{
		palette.Primary = scheme.Primary.ToMudColor();
		palette.PrimaryContrastText = scheme.OnPrimary.ToMudColor();
		palette.Secondary = scheme.Secondary.ToMudColor();
		palette.SecondaryContrastText = scheme.OnSecondary.ToMudColor();
		palette.Tertiary = markScheme.PrimaryContainer.ToMudColor();
		palette.TertiaryContrastText = markScheme.OnPrimaryContainer.ToMudColor();

		palette.AppbarText = scheme.OnPrimary.ToMudColor();
		palette.AppbarBackground = scheme.Primary.ToMudColor();

		palette.DrawerText = scheme.OnSurface.ToMudColor();
		palette.DrawerBackground = scheme.Surface.ToMudColor();

		palette.Background = scheme.Background.ToMudColor();
		palette.TextPrimary = scheme.OnBackground.ToMudColor();
		palette.TextSecondary = scheme.OnSurfaceVariant.ToMudColor();

		palette.SetPrimaryContainer(scheme.PrimaryContainer.ToMudColor());
		palette.SetOnPrimaryContainer(scheme.OnPrimaryContainer.ToMudColor());
		palette.SetSecondaryContainer(scheme.SecondaryContainer.ToMudColor());
		palette.SetOnSecondaryContainer(scheme.OnSecondaryContainer.ToMudColor());

		palette.Surface = scheme.Surface.ToMudColor();
		palette.SetOnSurface(scheme.OnSurface.ToMudColor());
		palette.SetSurfaceVariant(scheme.SurfaceVariant.ToMudColor());
		palette.SetOnSurfaceVariant(scheme.OnSurfaceVariant.ToMudColor());

		palette.LinesDefault = scheme.Outline.ToMudColor();
		palette.LinesInputs = scheme.Outline.ToMudColor();
		palette.TableLines = scheme.Outline.ToMudColor();
		palette.TableHover = scheme.ToHover(x => x.Surface).ToMudColor();

		palette.SetSurfaceContainerLowest(scheme.SurfaceContainerLowest.ToMudColor());
		palette.SetSurfaceContainerLow(scheme.SurfaceContainerLow.ToMudColor());
		palette.SetSurfaceContainer(scheme.SurfaceContainer.ToMudColor());
		palette.SetSurfaceContainerHigh(scheme.SurfaceContainerHigh.ToMudColor());
		palette.SetSurfaceContainerHighest(scheme.SurfaceContainerHighest.ToMudColor());

		return palette;
	}

	private void SetLiveChartsLightTheme()
	{
		LiveCharts.DefaultSettings.HasTheme(_ =>
		{
			LiveChartsSettings defaultSettings = new();

			LiveCharts.DefaultSettings.TooltipBackgroundPaint = defaultSettings.TooltipBackgroundPaint;
			LiveCharts.DefaultSettings.TooltipTextPaint = defaultSettings.TooltipTextPaint;
			LiveCharts.DefaultSettings.LegendTextPaint = defaultSettings.LegendTextPaint;
		});

		LiveCharts.DefaultSettings.AddLightTheme(chartsTheme =>
		{
			chartsTheme.Colors =
			[
				ThemeService.CurrentPalette.Primary.ToLvcColor(),
				CorePalette.Of(ColorUtils.ArgbFromRgb(156, 39, 176), Style.Vibrant).Primary[40].ToLvcColor(),
				CorePalette.Of(ColorUtils.ArgbFromRgb(33, 150, 243), Style.Vibrant).Primary[40].ToLvcColor(),
			];

			chartsTheme.HasRuleForAxes(axis =>
			{
				axis.NamePaint = ThemeService.CurrentPalette.OnSurface().ToPaint();
				axis.LabelsPaint = ThemeService.CurrentPalette.OnSurfaceVariant().ToPaint();
			});

			chartsTheme.HasRuleForLineSeries(rule =>
			{
				rule.Stroke!.StrokeThickness = 3.0f;

				rule.GeometrySize = 10;
				rule.GeometryStroke!.StrokeThickness = 3.0f;
			});
		});

		LiveCharts.DefaultSettings.WithTooltipBackgroundPaint(ThemeService.CurrentPalette.SurfaceContainerHigh().ToPaint());
		LiveCharts.DefaultSettings.WithTooltipTextPaint(ThemeService.CurrentPalette.OnSurface().ToPaint());
		LiveCharts.DefaultSettings.WithLegendTextPaint(ThemeService.CurrentPalette.OnSurface().ToPaint());
	}

	private void SetLiveChartsDarkTheme()
	{
		LiveCharts.DefaultSettings.HasTheme(_ =>
		{
			LiveChartsSettings defaultSettings = new();

			LiveCharts.DefaultSettings.TooltipBackgroundPaint = defaultSettings.TooltipBackgroundPaint;
			LiveCharts.DefaultSettings.TooltipTextPaint = defaultSettings.TooltipTextPaint;
			LiveCharts.DefaultSettings.LegendTextPaint = defaultSettings.LegendTextPaint;
		});

		LiveCharts.DefaultSettings.AddDarkTheme(chartsTheme =>
		{
			chartsTheme.Colors =
			[
				ThemeService.CurrentPalette.Primary.ToLvcColor(),
				CorePalette.Of(ColorUtils.ArgbFromRgb(156, 39, 176), Style.Vibrant).Primary[80].ToLvcColor(),
				CorePalette.Of(ColorUtils.ArgbFromRgb(33, 150, 243), Style.Vibrant).Primary[80].ToLvcColor(),
			];

			chartsTheme.HasRuleForAxes(axis =>
			{
				axis.NamePaint = ThemeService.CurrentPalette.OnSurface().ToPaint();
				axis.LabelsPaint = ThemeService.CurrentPalette.OnSurfaceVariant().ToPaint();
			});

			chartsTheme.HasRuleForLineSeries(rule =>
			{
				rule.Stroke!.StrokeThickness = 3.0f;

				rule.GeometrySize = 10;
				rule.GeometryStroke!.StrokeThickness = 3.0f;
			});
		});

		LiveCharts.DefaultSettings.WithTooltipBackgroundPaint(ThemeService.CurrentPalette.SurfaceContainerHigh().ToPaint());
		LiveCharts.DefaultSettings.WithTooltipTextPaint(ThemeService.CurrentPalette.OnSurface().ToPaint());
		LiveCharts.DefaultSettings.WithLegendTextPaint(ThemeService.CurrentPalette.OnSurfaceVariant().ToPaint());
	}
}
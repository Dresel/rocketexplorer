@using LiveChartsCore.Defaults
@inherits ChartBase

<ChartTemplate Title="@Title" Aggregation="aggregation" AggregationChanged="SetAggregation" Expanded="Expanded" ExpandedChanged="SetExpanded">
	@if (Data == null)
	{
		<MudText Align="Align.Center">
			<MudProgressCircular Class="mt-20 mb-20" Color="Color.Primary" Size="Size.Medium" Indeterminate="true" />
		</MudText>
	}
	else
	{
		<CartesianChart @key="Key" Series="Series" XAxes="XAxes" YAxes="YAxes" TooltipTextSize="13">
		</CartesianChart>
	}
</ChartTemplate>

@code {

	protected override void OnInitialized() =>
		Series =
		[
			new LineSeries<DateTimePoint>
			{
				LineSmoothness = 0,
				DataLabelsSize = 14,
			},
		];

	protected override async Task SetSeriesAsync()
	{
		// TODO: Support Data.Length > 1
		if (Series == null || Data == null || Series.Length != Data.Length)
		{
			return;
		}

		DateOnly target;

		switch (aggregation.Value)
		{
			case ChartAggregation.Yearly:
				if (Data.FirstOrDefault()?.Count > 0)
				{
					target = Data.FirstOrDefault()!.Min(x => x.Key);
					target = new DateOnly(target.Year - 1, 1, 1);
				}
				else
				{
					target = new DateOnly(2020, 1, 1);
				}

				break;

			case ChartAggregation.Monthly:
				target = DateOnly.FromDateTime(DateTime.Now).AddMonths(Expanded ? -36 : -12);
				target = new DateOnly(target.Year, target.Month, 1);
				break;

			case ChartAggregation.Daily:
				target = DateOnly.FromDateTime(DateTime.Now).AddDays(Expanded ? -42 : -14);
				break;

			default:
				throw new ArgumentOutOfRangeException(nameof(aggregation));
		}

		int oldCount = Series[0].Values?.OfType<DateTimePoint>().Count() ?? 0;
		List<DateTimePoint> dateTimePoints = Data.FirstOrDefault()?.PrepareTotal(aggregation, target).ToList() ?? [];

		// Workaround for regression, see https://github.com/Live-Charts/LiveCharts2/issues/2040
		if (dateTimePoints.Count < oldCount)
		{
			Series[0].Values = new List<DateTimePoint>();
			await Task.Delay(100);
		}

		Series[0].Values = dateTimePoints;
	}

}